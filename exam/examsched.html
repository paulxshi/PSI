<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMMA Examination Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="../imgs/PSI.png">

  <style>
    :root {
      --primary: #ef8809;
    }

    body {
      background: url('../imgs/bg.jpg') center center / cover no-repeat fixed;
    }

    .step {
      text-align: center;
      flex: 1;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .step-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid #ced4da;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      background: #fff;
    }

    .step-line {
      flex: 1;
      height: 2px;
      background: #dee2e6;
      margin-top: 20px;
    }

    .step.completed .step-circle {
      background: #198754;
      border-color: #198754;
      color: #fff;
    }

    .step.active .step-circle {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
      box-shadow: 0 6px 18px rgba(247, 222, 34, 0.45);
    }

 .btn-primary {
   background-color: var(--primary);
   border-color: var(--primary);
   color: #000;
   font-weight: 600;
 }

 .btn-primary:hover {
   background-color:#b56401;
   border-color: #b56401;
   color: #ffffff;
 }

  </style>
</head>

<body class="min-vh-100 d-flex align-items-center justify-content-center">

<div class="position-fixed top-0 start-0 w-100 h-100"
     style="backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index:0;"></div>

<div class="container position-relative" style="z-index:1;">
  <div class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-9">

      <div class="card shadow-lg border-0 rounded-4 bg-white bg-opacity-75">
        <div class="card-body p-4">

          <!-- LOGOS -->
          <div class="d-flex justify-content-center align-items-center mb-4">
            <img src="../imgs/PSI.png" style="max-width:80px;">
            <div class="mx-3" style="width:1px;height:40px;background:#8f8f8f;"></div>
            <img src="../imgs/PMMA.png" style="max-width:80px;">
          </div>

          <!-- STEPPER CARD -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body px-4 py-3">
              <div class="d-flex justify-content-between align-items-center">

                <div class="step completed">
                  <div class="step-circle">
                    <i class="bi bi-exclamation-circle"></i>
                  </div>
                  <span>Reminders</span>
                </div>

                <div class="step-line"></div>

                <div class="step completed">
                  <div class="step-circle">
                    <i class="bi bi-person-lines-fill"></i>
                  </div>
                  <span>Information</span>
                </div>

                <div class="step-line"></div>

                <div class="step active">
                  <div class="step-circle">
                    <i class="bi bi-calendar-check"></i>
                  </div>
                  <span>Exam Schedule</span>
                </div>

                <div class="step-line"></div>

                <div class="step">
                  <div class="step-circle">
                    <i class="bi bi-credit-card"></i>
                  </div>
                  <span>Payment</span>
                </div>

                <div class="step-line"></div>

                <div class="step">
                  <div class="step-circle">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <span>Finish</span>
                </div>

              </div>
            </div>
          </div>

<!-- EXAMINATION SCHEDULE CARD -->
<div class="card border-0 shadow-sm rounded-4">
  <div class="card-body p-4">

    <h6 class="fw-semibold mb-4">
      <i class="bi bi-calendar-check text-primary me-2"></i>
      Examination Schedule
    </h6>

    <form id="scheduleForm" method="POST" action="../php/save_examinee_schedule.php">

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Region</label>
          <select id="region" class="form-select" required>
            <option value="">Select Region</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Examination Venue</label>
          <select id="venue" name="venue_id" class="form-select" required>
            <option value="">Select Venue</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mb-4 align-items-end">

        <!-- Examination Date -->
        <div class="col-md-8">
          <label class="form-label fw-semibold">Examination Date</label>
          <select id="schedule" name="schedule_id" class="form-select" required>
            <option value="">Select Date</option>
          </select>
        </div>

        <!-- Examination Fee (smaller width) -->
        <div class="col-md-4" hidden>
          <label class="form-label fw-semibold">Examination Fee</label>
          <input
            type="text"
            id="examFee"
            class="form-control fw-semibold text-success"
            placeholder="â€”"
            readonly
          >
        </div>

      </div>



      <div class="alert alert-light border small text-muted mb-4">
        <i class="bi bi-info-circle me-1"></i>
        Examination schedules, venues, and regions are uploaded and assigned
        by PSI officials. Please wait for official announcements.
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <a href="registration.html" class="btn btn-outline-secondary px-4 rounded-pill">
          <i class="bi bi-arrow-left me-1"></i>
          Go Back
        </a>

        <button type="submit" id="proceedBtn" class="btn btn-primary px-4 rounded-pill" disabled>
          Proceed
          <i class="bi bi-arrow-right ms-1"></i>
        </button>
      </div>

    </form>

  </div>
</div>


        </div>
      </div>

    </div>
  </div>
</div>

<!-- SCHEDULE SAVE SUCCESS MODAL -->
<div class="modal fade" id="scheduleSuccessModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <div class="modal-header border-0 justify-content-center pb-2">
        <h5 class="modal-title fw-semibold">Schedule Confirmed</h5>
      </div>
      
      <div class="modal-body px-4 py-4 text-center">
        <div class="rounded-circle bg-success-subtle text-success mx-auto mb-3
                    d-flex align-items-center justify-content-center"
             style="width:64px;height:64px;">
          <i class="bi bi-calendar-check fs-1"></i>
        </div>
        
        <p class="mb-0 text-muted">
          Your examination schedule has been saved! Redirecting to payment...
        </p>
        
        <div class="mt-3">
          <div class="spinner-border spinner-border-sm text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- SCHEDULE SAVE ERROR MODAL -->
<div class="modal fade" id="scheduleErrorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <div class="modal-header border-0 justify-content-center pb-2">
        <h5 class="modal-title fw-semibold">Schedule Save Failed</h5>
        <button type="button" class="btn-close position-absolute end-0 me-3" 
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body px-4 py-4 text-center">
        <div class="rounded-circle bg-danger-subtle text-danger mx-auto mb-3
                    d-flex align-items-center justify-content-center"
             style="width:64px;height:64px;">
          <i class="bi bi-x-circle fs-1"></i>
        </div>
        
        <p class="mb-0 text-muted" id="scheduleErrorMessage">
          <!-- Error message will be inserted here -->
        </p>
      </div>
      
      <div class="modal-footer border-0 px-4 pb-4 pt-2 justify-content-center">
        <button type="button" class="btn btn-primary rounded-pill px-4" 
                data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-1"></i> Try Again
        </button>
      </div>
      
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const regionSelect = document.getElementById("region");
    const venueSelect = document.getElementById("venue");
    const scheduleSelect = document.getElementById("schedule");
    const examFeeInput = document.getElementById("examFee");
    const proceedBtn = document.getElementById("proceedBtn");
    const scheduleForm = document.getElementById("scheduleForm");

    // Function to validate form and enable/disable proceed button
    function validateForm() {
        const isValid = regionSelect.value && 
                       venueSelect.value && 
                       scheduleSelect.value;
        proceedBtn.disabled = !isValid;
    }

    // ðŸ”¹ Load Regions on Page Load
    fetch("../php/get_schedules.php?type=regions")
        .then(response => response.json())
        .then(data => {
            regionSelect.innerHTML = '<option value="">Select Region</option>';

            data.forEach(region => {
                const option = document.createElement("option");
                option.value = region.region;
                option.textContent = region.region;
                regionSelect.appendChild(option);
            });
        })
        .catch(error => console.error("Error loading regions:", error));


    // ðŸ”¹ When Region Changes â†’ Load Venues
    regionSelect.addEventListener("change", function () {

        const region = this.value;

        // Reset lower dropdowns
        venueSelect.innerHTML = '<option value="">Select Venue</option>';
        scheduleSelect.innerHTML = '<option value="">Select Date</option>';
        venueSelect.disabled = true;
        scheduleSelect.disabled = true;
        examFeeInput.value = "";
        validateForm();

        if (region === "") return;

        fetch("../php/get_schedules.php?type=venues&region=" + encodeURIComponent(region))
            .then(response => response.json())
            .then(data => {

                if (data.length === 0) {
                    venueSelect.innerHTML = '<option value="">No venues available</option>';
                    return;
                }

                data.forEach(venue => {
                    const option = document.createElement("option");
                    option.value = venue.venue_id;
                    option.textContent = venue.venue_name;
                    venueSelect.appendChild(option);
                });

                venueSelect.disabled = false;
            })
            .catch(error => console.error("Error loading venues:", error));
    });


    // ðŸ”¹ When Venue Changes â†’ Load Schedules 
    venueSelect.addEventListener("change", function () {

        const venueId = this.value;

        scheduleSelect.innerHTML = '<option value="">Select Date</option>';
        scheduleSelect.disabled = true;
        examFeeInput.value = "";
        validateForm();

        if (venueId === "") return;

        fetch("../php/get_schedules.php?type=schedules&venue_id=" + venueId)
            .then(response => response.json())
            .then(data => {

                if (data.length === 0) {
                    scheduleSelect.innerHTML = '<option value="">No schedules available</option>';
                    return;
                }

                data.forEach(schedule => {
                    const option = document.createElement("option");
                    option.value = schedule.schedule_id;

                    const date = new Date(schedule.scheduled_date + 'T00:00:00');

                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    const slots = schedule.available_slots || 0;
                    option.textContent = `${formattedDate} (${slots} slots available)`;

                    // ðŸ”¹ Store exam price as data attribute
                    option.dataset.fee = schedule.exam_price;

                    scheduleSelect.appendChild(option);
                });

                scheduleSelect.disabled = false;
            })
            .catch(error => console.error("Error loading schedules:", error));
    });

    // ðŸ”¹ When Schedule Changes â†’ Update Fee and Validate
    scheduleSelect.addEventListener("change", function () {

        const selectedOption = this.options[this.selectedIndex];
        const fee = selectedOption.dataset.fee;

        if (!fee) {
            examFeeInput.value = "";
        } else {
            examFeeInput.value = "â‚±" + Number(fee).toLocaleString();
        }
        
        validateForm();
    });

    // ðŸ”¹ Handle Form Submission
    scheduleForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        // Disable button and show loading
        proceedBtn.disabled = true;
        proceedBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        
        const formData = new FormData(this);
        
        fetch('../php/save_examinee_schedule.php', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Schedule Save Response:', data);
            
            if (data.success) {
                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('scheduleSuccessModal'));
                successModal.show();
                
                // Redirect to payment page after short delay
                setTimeout(() => {
                    window.location.href = '../payment/payment.html';
                }, 1500);
            } else {
                // Show error modal
                document.getElementById('scheduleErrorMessage').textContent = data.message || 'Failed to save schedule. Please try again.';
                const errorModal = new bootstrap.Modal(document.getElementById('scheduleErrorModal'));
                errorModal.show();
                
                // Reset button
                proceedBtn.disabled = false;
                proceedBtn.innerHTML = 'Proceed <i class="bi bi-arrow-right ms-1"></i>';
            }
        })
        .catch(error => {
            console.error('Error saving schedule:', error);
            
            // Show error modal
            document.getElementById('scheduleErrorMessage').textContent = 'Network error. Please try again.';
            const errorModal = new bootstrap.Modal(document.getElementById('scheduleErrorModal'));
            errorModal.show();
            
            // Reset button
            proceedBtn.disabled = false;
            proceedBtn.innerHTML = 'Proceed <i class="bi bi-arrow-right ms-1"></i>';
        });
    });

});
</script>

<script>
// Check user session on page load
(function() {
    fetch('../php/check_session.php', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (!data.authenticated) {
            // Redirect to login if not authenticated
            window.location.href = '../auth/login.html';
        }
    })
    .catch(error => {
        console.error('Session check failed:', error);
        window.location.href = '../auth/login.html';
    });
})();
</script>

</body>
</html>
