<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment - PMMA Examination</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="imgs/PSI.png">

  <style>
    :root {
      --primary: #ef8809;
    }

    body {
      background: url('imgs/bg.jpg') center center / cover no-repeat fixed;
    }

    .step {
      text-align: center;
      flex: 1;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .step-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid #ced4da;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      background: #fff;
    }

    .step-line {
      flex: 1;
      height: 2px;
      background: #dee2e6;
      margin-top: 20px;
    }

    .step.completed .step-circle {
      background: #198754;
      border-color: #198754;
      color: #fff;
    }

    .step.active .step-circle {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
      box-shadow: 0 6px 18px rgba(247, 222, 34, 0.45);
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
      color: #000;
      font-weight: 600;
    }

    .btn-primary:hover {
      background-color:#b56401;
      border-color: #b56401;
      color: #ffffff;
    }
  </style>
</head>

<body class="min-vh-100 d-flex align-items-center justify-content-center">

<div class="position-fixed top-0 start-0 w-100 h-100"
     style="backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index:0;"></div>

<div class="container position-relative" style="z-index:1;">
  <div class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-9">

      <div class="card shadow-lg border-0 rounded-4 bg-white bg-opacity-75">
        <div class="card-body p-4">

          <!-- LOGOS -->
          <div class="d-flex justify-content-center align-items-center mb-4">
            <img src="imgs/PSI.png" style="max-width:80px;">
            <div class="mx-3" style="width:1px;height:40px;background:#8f8f8f;"></div>
            <img src="imgs/PMMA.png" style="max-width:80px;">
          </div>

          <!-- STEPPER CARD -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body px-4 py-3">
              <div class="d-flex justify-content-between align-items-center">

                <div class="step completed">
                  <div class="step-circle">
                    <i class="bi bi-exclamation-circle"></i>
                  </div>
                  <span>Reminders</span>
                </div>

                <div class="step-line"></div>

                <div class="step completed">
                  <div class="step-circle">
                    <i class="bi bi-person-lines-fill"></i>
                  </div>
                  <span>Information</span>
                </div>

                <div class="step-line"></div>

                <div class="step completed">
                  <div class="step-circle">
                    <i class="bi bi-calendar-check"></i>
                  </div>
                  <span>Exam Schedule</span>
                </div>

                <div class="step-line"></div>

                <div class="step active">
                  <div class="step-circle">
                    <i class="bi bi-credit-card"></i>
                  </div>
                  <span>Payment</span>
                </div>

                <div class="step-line"></div>

                <div class="step">
                  <div class="step-circle">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <span>Finish</span>
                </div>

              </div>
            </div>
          </div>

          <!-- PAYMENT CARD -->
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">

              <h6 class="fw-semibold mb-4">
                <i class="bi bi-credit-card me-2 text-primary"></i>
                Payment Information
              </h6>

              <!-- Loading State -->
              <div id="loadingState" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading your exam details...</p>
              </div>

              <!-- Error State -->
              <div id="errorState" class="d-none">
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <span id="errorMessage">Unable to load payment information.</span>
                </div>
                <div class="d-flex justify-content-between">
                  <a href="examsched.html" class="btn btn-outline-secondary px-4 rounded-pill">
                    <i class="bi bi-arrow-left me-1"></i>
                    Go Back
                  </a>
                </div>
              </div>

              <!-- Payment Details -->
              <div id="paymentDetails" class="d-none">
                
                <!-- Exam Summary -->
                <div class="card bg-light border-0 mb-4">
                  <div class="card-body p-3">
                    <h6 class="fw-semibold mb-3">Examination Summary</h6>
                    <div class="row g-2 small">
                      <div class="col-6 text-muted">Test Permit:</div>
                      <div class="col-6 text-end fw-semibold" id="testPermit">‚Äî</div>
                      
                      <div class="col-6 text-muted">Examinee Name:</div>
                      <div class="col-6 text-end fw-semibold" id="examineeName">‚Äî</div>
                      
                      <div class="col-6 text-muted">Venue:</div>
                      <div class="col-6 text-end fw-semibold" id="venue">‚Äî</div>
                      
                      <div class="col-6 text-muted">Exam Date:</div>
                      <div class="col-6 text-end fw-semibold" id="examDate">‚Äî</div>
                      
                      <div class="col-12"><hr class="my-2"></div>
                      
                      <div class="col-6 text-muted">Examination Fee:</div>
                      <div class="col-6 text-end fw-bold text-success" id="examFee">‚Äî</div>
                    </div>
                  </div>
                </div>

                <!-- Payment Instructions -->
                <div>
                  <h6>Before You Proceed to Payment</h6>
                  <p class="mb-3">
                    To complete your transaction, you will be securely redirected to our trusted payment partner's checkout page.
                  </p>

                  <p><b>What to expect:</b></p>
                  <ul>
                    <li>After clicking "Proceed to Payment", you will be redirected to a secure payment page.</li>
                    <li>You can choose your preferred payment method (e.g., e-Wallet, Online Banking, Card, or other available options).</li>
                    <li>Once payment is completed, you will be automatically redirected back to our website.</li>
                    <li>You will also receive a confirmation once your transaction is successful.</li>
                  </ul>

                  <p><b>Important Reminders:</b></p>
                  <ul>
                    <li>Do not close the payment page while the transaction is processing.</li>
                    <li>Make sure to complete the payment within the given time to avoid expiration.</li>
                    <li>If the page does not redirect automatically after payment, you may return to our website and check your order status.</li>
                  </ul>

                  <p class="small text-muted"><i class="bi bi-shield-check me-1"></i>This payment is processed securely through Xendit. Your payment information is encrypted and protected.</p>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <a href="examsched.html" class="btn btn-outline-secondary px-4 rounded-pill">
                    <i class="bi bi-arrow-left me-1"></i>
                    Go Back
                  </a>
                  
                  <div>
                    
                    <button type="button" id="payNowBtn" class="btn btn-primary px-4 rounded-pill">
                      Proceed to Payment <i class="bi bi-check ms-1"></i>
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
let examData = null;

document.addEventListener('DOMContentLoaded', function() {
  loadExamDetails();
  
  document.getElementById('payNowBtn').addEventListener('click', initiatePayment);
});

// Load exam details from server
function loadExamDetails() {
  fetch('php/get_payment_details.php', {
    method: 'GET',
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    console.log('Payment Details:', data);
    
    if (data.success) {
      examData = data.data;
      displayExamDetails(data.data);
      
      // Show payment details, hide loading
      document.getElementById('loadingState').classList.add('d-none');
      document.getElementById('paymentDetails').classList.remove('d-none');
    } else {
      showError(data.message || 'Unable to load payment information.');
    }
  })
  .catch(error => {
    console.error('Error loading exam details:', error);
    showError('Network error. Please try again.');
  });
}

// Display exam details in the UI
function displayExamDetails(data) {
  document.getElementById('testPermit').textContent = data.test_permit || '‚Äî';
  document.getElementById('examineeName').textContent = data.full_name || '‚Äî';
  document.getElementById('venue').textContent = data.venue_name || '‚Äî';
  
  // Format date
  if (data.scheduled_date) {
    const date = new Date(data.scheduled_date + 'T00:00:00');
    const formatted = date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    document.getElementById('examDate').textContent = formatted;
  }
  
  // Format price
  if (data.price) {
    document.getElementById('examFee').textContent = '‚Ç±' + parseFloat(data.price).toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }
}

// Show error state
function showError(message) {
  document.getElementById('loadingState').classList.add('d-none');
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorState').classList.remove('d-none');
}

// Initiate payment through Xendit
function initiatePayment() {
  if (!examData) {
    alert('Exam details not loaded. Please refresh the page.');
    return;
  }
  
  const payNowBtn = document.getElementById('payNowBtn');
  payNowBtn.disabled = true;
  payNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating invoice...';
  
  fetch('php/create_payment.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({
      amount: examData.price,
      description: `PMMA Examination Fee - ${examData.test_permit}`
    })
  })
  .then(response => response.json())
  .then(data => {
    console.log('Payment Creation Response:', data);
    
    // Log detailed error information if present
    if (!data.success) {
      console.error('‚ùå Payment Failed:', data.message);
      
      if (data.error_type) {
        console.error('Error Type:', data.error_type);
      }
      
      if (data.error_details) {
        console.error('Error Details:', data.error_details);
      }
      
      if (data.file && data.line) {
        console.error(`Location: ${data.file} (Line ${data.line})`);
      }
      
      if (data.full_path) {
        console.error('Full Path:', data.full_path);
      }
      
      if (data.suggestion) {
        console.warn('üí° Suggestion:', data.suggestion);
      }
      
      if (data.debug) {
        console.error('Debug Info:', data.debug);
      }
      
      if (data.missing_extensions) {
        console.error('‚ùå Missing PHP Extensions:', data.missing_extensions);
        alert(`Server Error: Missing PHP extensions: ${data.missing_extensions.join(', ')}\n\nPlease enable these in php.ini and restart Apache.`);
      } else {
        alert(data.message || 'Failed to create payment invoice. Please try again.');
      }
      
      payNowBtn.disabled = false;
      payNowBtn.innerHTML = 'Proceed to Payment <i class="bi bi-check ms-1"></i>';
      return;
    }
    
    if (data.success && data.invoice_url) {
      // Redirect to Xendit payment page
      window.location.href = data.invoice_url;
    } else {
      alert(data.message || 'Failed to create payment invoice. Please try again.');
      payNowBtn.disabled = false;
      payNowBtn.innerHTML = 'Proceed to Payment <i class="bi bi-check ms-1"></i>';
    }
  })
  .catch(error => {
    console.error('Error creating payment:', error);
    alert('Network error. Please try again.');
    payNowBtn.disabled = false;
    payNowBtn.innerHTML = 'Proceed to Payment <i class="bi bi-check ms-1"></i>';
  });
}
</script>

<script>
// Check user session on page load
(function() {
    fetch('php/check_session.php', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (!data.authenticated) {
            // Redirect to login if not authenticated
            window.location.href = 'auth/login.html';
        }
    })
    .catch(error => {
        console.error('Session check failed:', error);
        window.location.href = 'auth/login.html';
    });
})();
</script>

</body>
</html>
