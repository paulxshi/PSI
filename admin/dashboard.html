<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="../imgs/PSI.png">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<link href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" href="../css/dashstyle.css">
  <link rel="stylesheet" href="../css/style.css">

	<title>Dashboard</title>
</head>


<style>
#qrResultModal .modal-dialog {
  max-width: 420px;
}

.verification-icon {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.verification-icon i {
  font-size: 3.5rem;
  transition: transform 0.3s ease;
}

.modal-valid .verification-icon {
  background: linear-gradient(135deg, #d4f5e6 0%, #a8e6cf 100%);
  box-shadow: 0 8px 32px rgba(25, 135, 84, 0.3);
}
.modal-valid .verification-icon i {
  color: #198754;
  animation: pulse-success 2s infinite;
}

.modal-warning .verification-icon {
  background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
  box-shadow: 0 8px 32px rgba(255, 193, 7, 0.3);
}
.modal-warning .verification-icon i {
  color: #ffc107;
  animation: pulse-warning 2s infinite;
}

.modal-invalid .verification-icon,
.modal-rejected .verification-icon,
.modal-already_used .verification-icon {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
}
.modal-invalid .verification-icon i,
.modal-rejected .verification-icon i,
.modal-already_used .verification-icon i {
  color: #dc3545;
  animation: shake 0.5s ease-in-out;
}

/* Animations */
@keyframes pulse-success {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes pulse-warning {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* STATUS TEXT - Modern Minimalist Style */
.status-box {
  display: inline-block;
  padding: 8px 0;
  font-weight: 600;
  font-size: 0.95rem;
  letter-spacing: 0.05em;
  margin-bottom: 15px;
  text-transform: uppercase;
  background: transparent;
  border: none;
}

/* Valid state */
.status-box.valid {
  color: #059669;
}

/* Warning state */
.status-box.warning {
  color: #dc2626;
}

/* Invalid state */
.status-box.invalid,
.status-box.rejected,
.status-box.already_used {
  color: #d90606;
}

/* DETAILS CARD */
.verify-card {
  background: #f8f9fa;
  border-radius: 14px;
  padding: 14px 18px;
  text-align: left;
  max-width: 360px;
  margin: 0 auto;
}

.verify-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: .9rem;
  border-bottom: 1px dashed #dee2e6;
}

.verify-row:last-child {
  border-bottom: none;
}

/* TIMER - Minimal Modern Style */
.auto-timer {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: #6b7280;
  font-size: 0.85rem;
  font-weight: 500;
  letter-spacing: 0.02em;
  margin-top: 8px;
}

.auto-timer i {
  font-size: 0.85rem;
  color: #9ca3af;
}

.auto-timer #timerCount {
  font-weight: 600;
  color: #374151;
  min-width: 14px;
  text-align: center;
}

.auto-timer #cancelAutoComplete {
  border: none;
  background: transparent;
  color: #6b7280;
  font-size: 0.8rem;
  padding: 0;
  cursor: pointer;
}

.auto-timer #cancelAutoComplete:hover {
  color: #374151;
}

/* MODAL BUTTONS */
.modal-footer .btn {
  border-radius: 999px;
  padding: 8px 22px;
  font-weight: 500;
}

/* ICON COLORS */
.modal-valid .verification-icon i {
  color: #198754;
}
.modal-warning .verification-icon i {
  color: #ffc107;
}
.modal-invalid .verification-icon i,
.modal-rejected .verification-icon i,
.modal-already_used .verification-icon i {
  color: #dc3545;
}

.dropdown-menu {
  border-radius: 12px;
  min-width: 180px;
}

.dropdown-item {
  font-size: 14px;
  padding: 10px 14px;
}

.dropdown-item i {
  font-size: 18px;
}

.dropdown-item:hover {
  background-color: #f8f9fa;
}

.status-badge {
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.85rem;
  display: inline-block;
}

.status-badge.completed {
  color: #198754;                 
}
@media print {
  body {
    background: #fff !important;
  }

  .table-card {
    box-shadow: none !important;
    border: 1px solid #c2c2c2;
  }
}
.btn-close:focus,
.no-focus:focus {
    outline: none;
    box-shadow: none;
}

@media (min-width: 992px) {
  .region-divider {
    border-right: 1px solid #e9ecef;
  }
}
.input-group-text {
  border-right: 0;
}

.input-group .form-control:focus {
  box-shadow: none;
}

.input-group:focus-within {
  box-shadow: 0 0 0 0.15rem rgba(13,110,253,.15);
}

.region-table-row {
  border-radius: 0.5rem;
  transition: 
    background-color 0.2s ease,
    box-shadow 0.2s ease,
    transform 0.15s ease;
}

.region-table-row.selected {
  background-color: rgba(93, 226, 253, 0.2); 
  border: 2px solid #9a7bff; 
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.2), 0 0 10px rgba(0, 0, 0, 0.1);
}

</style>
<body>

	<!-- Sidebar Section -->
    <section id="sidebar">
        <a href="#" class="brand" style="display: flex; align-items: center;">
          <img src="../imgs/PSI.png" alt="RHULogo" class="logo">
          <span class="text">PSI-ADMIN Portal</span>
        </a>
        <ul class="side-menu top">
          <li class="active">
            <a href="dashboard.html">
              <i class="bx bxs-dashboard"></i>
              <span class="text">Dashboard</span>
            </a>
          </li>

          <li>
            <a href="schedule.html">
              <i class="bx bx-calendar-check"></i>
              <span class="text">Create Schedule</span>
            </a>
          </li>

          <li>
            <a href="managesched.html">
              <i class="bx bx-edit"></i>
              <span class="text">Schedule Management</span>
            </a>
          </li>

            <li>
                <a href="masterlist.html">
                    <i class="bx bx-list-ul"></i>
                    <span class="text">Examinee Masterlist</span>
                </a>
            </li>
         
            <li>
                <a href="examinee.html">
                    <i class="bx bx-group"></i>
                    <span class="text">Examinee Management</span>
                </a>
            </li>  
                            <li>
                    <a href="examhistory.html">
                        <i class="bx bx-history"></i>
                        <span class="text">Exam History</span>
                    </a>
                </li> 
                
                <li>
                    <a href="activity_log.html">
                        <i class="bx bx-notepad"></i>
                        <span class="text">Activity Log</span>
                    </a>
                </li>

                <li>
                   <a href="faqsmanagement.html">
                       <i class="bx bx-task"></i>
                        <span class="text">FAQs Management </span>
                    </a>
                </li>
          
        </ul>
    </ul>		
  </section>

	<section id="content">
    <nav class="d-flex justify-content-end align-items-center px-4">
      
      <div class="dropdown">
        <!-- Admin Icon -->
        <a href="#"
          class="d-flex align-items-center text-decoration-none"
          id="adminDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false">
          
          <i class="bx bxs-user-circle fs-2 text-primary"></i>
          <i class="bx bx-chevron-down ms-1 text-muted"></i>
        </a>

        <!-- Dropdown Menu -->
        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2">
          <li class="dropdown-header small text-muted">
            Administrator
          </li>

          <li><hr class="dropdown-divider"></li>

          <li>
            <a class="dropdown-item d-flex align-items-center text-danger"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#logoutModal">
              <i class="bx bxs-log-out-circle me-2"></i>
              Logout
            </a>
          </li>
        </ul>
      </div>

    </nav>
<main>

  <div class="container-fluid mt-3 mb-4">
  <div class="card border-0 shadow-sm rounded-4 p-3">
    <div class="d-flex align-items-center gap-3">

      <!-- Message -->
      <div>
        <h6 class="mb-1 fw-bold text-uppercase" style="letter-spacing:0.08em;">
          Dashboard
        </h6>
          <p class="mb-0 text-muted small">
            Administrative dashboard for monitoring examination schedules, tracking completed examinees, managing venue capacity allocations, and performing manual QR code verification for on-site validation.
          </p>
      </div>

    </div>
  </div>
</div>

<div class="container-fluid mb-4">
  <div class="row justify-content-start">
    <div class="col-xl-4 col-lg-5 col-md-7 col-sm-10">

      <div class="card border-0 rounded-4 p-4">
        <div class="d-flex align-items-center gap-2 mb-3">
          <i class="bx bx bx-qr text-primary fs-5"></i>
          <h6 class="mb-0 fw-semibold">Manual QR Test</h6>
        </div>

        <div class="input-group input-group-md">

          <span class="input-group-text bg-light">
            <i class="bx bx-qr-scan text-muted"></i>
          </span>

          <input
            type="text"
            id="manualQR"
            class="form-control shadow-none"
            placeholder="Enter QR value"
          >

<button id="scanBtn" class="btn btn-primary px-3">
  Scan
</button>

        </div>

        <small class="text-muted d-block mt-2">
          Manual QR validation through direct entry of the QR code value.

        </small>
      </div>

    </div>
  </div>
</div>

  <div class="container-fluid mt-4">

   <div class="row g-3 justify-content-start region-row-wrapper">
 
  <div class="container-fluid mt-4">
    <div class="card border-0 shadow-sm rounded-4 p-4">
      
         <h6 class="mb-0 fw-semibold">Please Select Schedule For Scanning:</h6> <br>
      <div class="row g-4" id="regionsContainer">
        <!-- JS injects regions as columns -->
      </div>
    </div>
  </div>



 

  </div>
</div>
    <!-- PRINT HEADER -->
    <div class="d-none d-print-block mb-4">

      <div class="row align-items-center text-center">
        
        <!-- Left Logo -->
        <div class="col-2 text-start">
          <img src="../imgs/PSI.png" alt="PSI Logo" class="img-fluid" style="max-height:70px;">
        </div>

        <!-- Center Text -->
        <div class="col-8">
          <div class="fw-bold text-uppercase small">
            Psy Systems and Innovation, OPC
          </div>

          <div class="text-muted small">
            Philippine Merchant Marine Academy<br>
            Examination Registration Report
          </div>

          <div class="fw-bold mt-3 text-uppercase" style="letter-spacing:0.18em;">
            Registered Examinees — Manila
          </div>
        </div>

        <!-- Right Logo -->
        <div class="col-2 text-end">
          <img src="../imgs/PMMA.png" alt="PMMA Logo" class="img-fluid" style="max-height:70px;">
        </div>

      </div>

      <hr class="mt-4">
    </div>

    <!-- TABLE SECTION -->
    <div class="container-fluid py-5">
      <div class="container py-4">

      <div class="card table-card border-0 overflow-hidden">

        <div class="px-4 py-3 border-bottom bg-white">
          <div class="d-flex align-items-center">


            
            

            <!-- Title -->
            <h6 class="fw-semibold mb-0">
               Completed Examinees: <span id="completedCount">0</span>
            </h6> <br>

             <h6 class="fw-semibold mb-0">
               <span id="currentDate" class="mb-0 ms-2"> </span>
            </h6>



              <!-- RIGHT GROUP (HORIZONTAL, NO WRAP) -->
            <div class="ms-auto d-flex align-items-center gap-2 flex-nowrap">

              <!-- Search -->
              <input type="search"
                    class="form-control form-control-sm"
                    style="width:260px;"
                    placeholder="Search test permit, name, or email">

            </div>

          </div>
          <div></div>
        </div>


<div class="table-responsive">
  <table class="table align-middle mb-0 table-hover">
    <thead class="small text-uppercase text-muted">
      <tr>
        <th>Test Permit</th>
        <th>Transaction No</th>
        <th>Name</th>
        <th>Date of Examination</th>
        <th>Email</th>
        <th>Scanned at</th>
        <th>Status</th>
      </tr>
    </thead>

    <tbody id="examineeTableBody">
      <!-- Data will be inserted here -->
    </tbody>
  </table>
</div>

<script src="js/dashboard_table.js"></script>

        </div>

      </div>
    </div> 

<!-- QR RESULT MODAL -->
<div class="modal fade" id="qrResultModal" tabindex="-1" aria-hidden="true">
 <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title" hidden>Examinee Verification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body px-6 py-4 text-center">

        <!-- STATUS ICON -->
          <div class="verification-icon mb-3">
            <div class="icon-3d">
              <i id="statusIcon" class="fa-solid fa-circle-check"></i>
            </div>
          </div>

        <!-- STATUS TEXT -->
        <div id="verificationStatus" class="status-box valid">

        </div>


        <!-- ✅ EXAMINEE INFORMATION    -->
        <div class="section mb-4" hidden>
          <h6 class="border-bottom pb-2">Examinee Information</h6>
          <div class="row">
            <div class="col-4 fw-bold">Name:</div>
            <div class="col-8" id="name"></div>

            <div class="col-4 fw-bold">Test Permit No:</div>
            <div class="col-8" id="test_permit"></div>
          </div>
        </div> 



        <!-- ✅ EXAM DETAILS -->
        <div class="section mb-4" id="exam_sched" style="display: none;">
          <h6 class="border-bottom pb-2">Examination Details</h6>
          <div class="row">
            <div class="col-4 fw-bold">Date:</div>
            <div class="col-8" id="examination_date"></div>

            <div class="col-4 fw-bold">Venue:</div>
            <div class="col-8" id="examination_venue"></div>
          </div>
        </div>


        <!-- ✅ PAYMENT CONFIRMATION         -->
        <div class="section mb-2" hidden>
          <h6 class="border-bottom pb-2">Payment Confirmation</h6>
          <div class="row">
            <div class="col-4 fw-bold">Transaction No:</div>
            <div class="col-8" id="invoice_no"></div>

            <div class="col-4 fw-bold">Payment Status:</div>
            <div class="col-8" id="status"></div>

            <div class="col-4 fw-bold">Payment Date:</div>
            <div class="col-8" id="payment_date"></div>

            <div class="col-4 fw-bold">Amount:</div>
            <div class="col-8" id="payment_amount"></div>
          </div>
        </div>
    

      </div>

      <!-- AUTO COMPLETE TIMER -->
      <div id="autoCompleteTimer" class="text-center" style="display: none;">
        <span class="auto-timer">
          <i class="fa-solid fa-clock"></i>
          Auto accepting in <strong id="timerCount">5</strong>s
          <button id="cancelAutoComplete" class="btn btn-sm btn-link text-secondary text-decoration-none p-0 ms-1">Cancel</button>
        </span>
      </div>

      <!-- FOOTER ACTIONS -->
      <div class="modal-footer border-0 pt-3 justify-content-center gap-2">
        <button class="btn btn-danger btn-sm px-4" id="cancelBtn1">Cancel</button>
        <button class="btn btn-success btn-sm px-4" id="completeBtn">Accept</button>
      </div>

    </div>
  </div>
</div>


</main>

<div
    class="modal fade"
    id="logoutModal"
    tabindex="-1"
    aria-labelledby="logoutModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">

            <!-- Modal Header -->
            <div class="modal-header bg-light border-0 rounded-top-4 px-4 py-3">
                <h5 class="modal-title fw-bold mb-0" id="logoutModalLabel">
                    Confirm Logout
                </h5>
                <button
                    type="button"
                    class="btn-close no-focus"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>

            <!-- Divider -->
            <div class="px-4">
                <hr class="my-0">
            </div>

            <!-- Modal Body -->
            <div class="modal-body px-4 py-4 text-center">
                <i class="bx bx-log-out-circle fs-1 text-muted mb-3"></i>
                <p class="mb-0 text-muted">
                    Are you sure you want to log out of your account?
                </p>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer border-0 px-4 pb-4 pt-2 justify-content-center">
                <button
                    type="button"
                    class="btn btn-outline-secondary rounded-pill px-4"
                    data-bs-dismiss="modal"
                >
                    Cancel
                </button>
                <a
                    href="../php/adminlogout.php"
                    class="btn btn-danger rounded-pill px-4"
                >
                    Logout
                </a>
            </div>

        </div>
    </div>
</div>

<script src="js/scanner.js"></script>
<script>



  const btn = document.getElementById("scanBtn");

  btn.addEventListener("click", simulateScan);

  document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      btn.click();
    }
  });

function simulateScan() {

    const fakeQR = document.getElementById("manualQR").value.trim();

    if (!fakeQR) {
        alert("Enter QR value first.");
        return;
    }

    console.log("Simulated Scan:", fakeQR);

    // This calls the SAME function used by real scanner
    onScanSuccess(fakeQR);
}






document.addEventListener("DOMContentLoaded", () => {
    fetch("php/dashboard.php")
        .then(res => res.json())
        .then(data => renderRegions(data));



            const searchInput = document.querySelector('input[type="search"]');
    searchInput.addEventListener('input', function() {
        const filter = this.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#examineeTableBody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const text = (cells[0].textContent + cells[1].textContent + cells[2].textContent).toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });
});


/* ✅ Dynamic Toggle (Event Delegation) */
document.addEventListener("click", function(e) {

    const header = e.target.closest(".venue-header");
    if (!header) return;

    const targetId = header.dataset.target;
    const schedule = document.getElementById(targetId);
    const icon = header.querySelector(".venue-toggle");

    if (!schedule) return;

    schedule.classList.toggle("show");
    icon.classList.toggle("open");
});


function renderRegions(data) {
  const container = document.getElementById("regionsContainer");
  container.innerHTML = "";

  Object.keys(data).forEach(region => {

    let regionHTML = `
      <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 region-divider">
        <div class="h-100">

          <h6 class="fw-bold text-uppercase text-muted mb-3"
              style="letter-spacing:0.12em;">
            ${region}
          </h6>

          <div class="region-table">
            <div class="region-table-header"
                 style="grid-template-columns: 2fr 1fr 1fr 1fr;">
              <span>Venue</span>
              <span>Registered</span>
              <span>Limit</span>
              <span>Available</span>
            </div>
    `;

    Object.keys(data[region]).forEach(venue => {
      const venueId = `${region}-${venue}`.replace(/\s+/g, '-');

      regionHTML += `
        <div class="venue-header d-flex justify-content-between align-items-center mb-1"
             data-target="${venueId}">
          <strong>${venue}</strong>
          <button class="venue-toggle">
            <i class="bx bx-chevron-down"></i>
          </button>
        </div>

        <div class="venue-schedule" id="${venueId}">
      `;

      data[region][venue].forEach(sched => {
        const available = sched.limit - sched.registered;

          regionHTML += `
            <div class="region-table-row"
                 style="grid-template-columns: 2fr 1fr 1fr 1fr;"
                 data-region="${region}"
                 data-venue="${venue}"
                 data-date="${sched.date}"
                 data-schedule-id="${sched.schedule_id}"
                 onclick="selectSchedule('${region}', '${venue}', '${sched.date}', this)">
              <span>${formatDate(sched.date)}</span>
              <span class="fw-semibold">${sched.registered}</span>
              <span class="fw-semibold text-danger">${sched.limit}</span>
              <span class="fw-semibold text-success">${available}</span>
            </div>
          `;
      });

      regionHTML += `</div>`;
    });

    regionHTML += `
          </div>
        </div>
      </div>
    `;

    container.insertAdjacentHTML("beforeend", regionHTML);
  });
}


function formatDate(date) {
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}


let schedule_id = null;

function selectSchedule(region, venue, date, element) {

      schedule_id = element.dataset.scheduleId;

    console.log("DEBUG: Selected schedule_id =", schedule_id);

    if (element.classList.contains('selected')) {
      // Unselect
      element.classList.remove('selected');
      window.selectedRegion = null;
      window.selectedVenue = null;
      window.selectedDate = null;
      window.selectedScheduleId = null;
      console.log("Unselected schedule");
    } else {
      // Remove selected class from all rows
      document.querySelectorAll('.region-table-row.selected').forEach(row => {
        row.classList.remove('selected');
      });

      // Add selected class to clicked row
      element.classList.add('selected');

      // Store selected values globally
      window.selectedRegion = region;
      window.selectedVenue = venue;
      window.selectedDate = date;
      window.selectedScheduleId = schedule_id;

      console.log(`Selected: Region=${region}, Venue=${venue}, Date=${date}, ScheduleID=${window.selectedScheduleId}`);
    }
}
</script>

<script>
// Check admin session on page load
(function() {
    fetch('php/check_session.php', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (!data.authenticated) {
            // Redirect to admin login if not authenticated
            window.location.href = '../adminlogin.html';
        }
    })
    .catch(error => {
        console.error('Session check failed:', error);
        window.location.href = '../adminlogin.html';
    });
})();
</script>

</body>
</html>
